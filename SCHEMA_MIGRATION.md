# Schema Migration: Profiles to Users

This document explains the process of migrating from a dual-table approach (profiles and users) to a single users table in the Supabase database.

## Background

The application was experiencing errors when creating new users, specifically:

```
column users.email does not exist
```

Upon investigation, we discovered that the database schema had a problematic dual-table approach:

1. `auth.users` - The built-in Supabase auth table
2. `public.profiles` - A table containing user profile information (including email)
3. `public.users` - A table linked to auth.users but missing the email column

This dual-table approach was causing confusion in the application code, with some parts trying to access `users.email` which didn't exist.

## Migration Plan

The migration involves the following steps:

1. **Consolidate Schema**: Move all necessary columns from profiles to users
2. **Migrate Data**: Copy data from profiles to users
3. **Update Trigger**: Modify the auth trigger to only use the users table
4. **Update Code References**: Change all references from profiles to users in the codebase

## Migration Scripts

The following scripts have been created to assist with the migration:

1. **consolidate-schema.js** - Consolidates the database schema
2. **find-profile-references.js** - Finds all references to profiles in the codebase
3. **update-profile-references.js** - Updates references from profiles to users

## How to Run the Migration

### Step 1: Backup Your Database

Before proceeding, make sure to create a backup of your Supabase database.

### Step 2: Consolidate Schema

Run the schema consolidation script:

```bash
node consolidate-schema.js
```

This script will:
- Add missing columns from profiles to users (including email)
- Migrate data from profiles to users
- Update the trigger function to only use the users table
- Test the new setup with a sample user

### Step 3: Find Code References

Run the script to find all references to profiles in your codebase:

```bash
node find-profile-references.js
```

This will generate a report (`profile-references.md`) listing all files that need to be updated.

### Step 4: Update Code References

Run the script to update all references from profiles to users:

```bash
node update-profile-references.js
```

This script will:
- Create backups of all modified files in a `backups` directory
- Replace references to profiles with users
- Generate a log file (`update-references.log`) with details of all changes

### Step 5: Test Your Application

After running the migration scripts, thoroughly test your application to ensure everything works correctly.

## Manual Adjustments

Some code changes might require manual adjustments, especially:

1. Complex queries involving both profiles and users tables
2. Custom business logic that depends on the dual-table structure
3. TypeScript interfaces and types that need careful updating

## Rollback Plan

If you encounter issues after the migration:

1. Restore your database backup
2. Copy the original files from the `backups` directory back to their original locations

## Post-Migration Cleanup

After confirming everything works correctly, you can:

1. Drop the profiles table if it's no longer needed
2. Remove the backup files
3. Update your database documentation to reflect the new schema

## Support

If you encounter any issues during the migration, please refer to the log files generated by the scripts for detailed information. 